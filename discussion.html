<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Discussion - UmmahConnect</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* Custom styles for enhanced UI */
    .post-card {
      transition: all 0.3s ease;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .post-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }
    
    .new-post-section {
      background: linear-gradient(to right, #f8fafc, #f1f5f9);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .reply-section {
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }
    
    .animate-fadeIn { 
      animation: fadeIn 0.5s ease forwards; 
    }
    
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(10px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(79, 70, 229, 0.3);
      border-radius: 50%;
      border-top-color: #4f46e5;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .section-title {
      position: relative;
      padding-bottom: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
    .section-title:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50px;
      height: 3px;
      background-color: #4f46e5;
      border-radius: 3px;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6b7280;
    }
    
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      color: #d1d5db;
    }
    
    .like-btn {
      transition: all 0.2s ease;
    }
    
    .like-btn:hover {
      color: #4f46e5;
      transform: scale(1.1);
    }
    
    .like-btn.liked {
      color: #4f46e5;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

  <!-- Navbar -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto flex flex-col md:flex-row justify-between items-center py-4 px-6 gap-3 md:gap-0">
      <div class="flex items-center gap-2">
        <h1 class="text-2xl font-bold text-indigo-600">UmmahConnect</h1>
        <span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full font-medium">Discussion</span>
      </div>
      <nav class="flex gap-5 items-center flex-wrap justify-center">
        <a href="feed.html" class="text-gray-600 hover:text-indigo-600 transition">Feed</a>
        <a href="discussion.html" class="text-indigo-600 font-medium border-b-2 border-indigo-600 pb-1 transition">Discussion</a>
        <a href="profile.html" class="text-gray-600 hover:text-indigo-600 transition">Profile</a>
        <button id="logoutBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-500 transition flex items-center gap-2">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto my-8 px-4 md:px-6">
    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">Community Discussion</h1>
      <p class="text-gray-600">Join the conversation and connect with the UmmahConnect community</p>
    </div>

    <!-- New Post Section (hidden if not logged in) -->
    <div id="postBox" class="new-post-section shadow-sm hidden">
      <h2 class="section-title text-lg font-semibold text-gray-800">Create a New Post</h2>
      <div class="flex flex-col md:flex-row gap-3">
        <div class="flex-1">
          <textarea id="postInput" placeholder="What's on your mind? Share your thoughts with the community..." 
            class="w-full p-4 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 resize-none" 
            rows="3"></textarea>
          <p class="text-xs text-gray-500 mt-1">Share your ideas, questions, or experiences with the community</p>
        </div>
        <div class="flex md:flex-col gap-2 md:justify-center">
          <button id="postBtn" class="bg-indigo-600 text-white px-5 py-3 rounded-lg hover:bg-indigo-500 transition flex items-center gap-2 h-fit">
            <i class="fas fa-paper-plane"></i> Post
          </button>
          <button id="clearPostBtn" class="bg-gray-200 text-gray-700 px-5 py-3 rounded-lg hover:bg-gray-300 transition flex items-center gap-2 h-fit">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
      </div>
    </div>

    <!-- Posts Section -->
    <div class="mt-8">
      <h2 class="section-title text-lg font-semibold text-gray-800">Recent Posts</h2>
      <div id="postContainer" class="space-y-6">
        <!-- Posts will be inserted dynamically -->
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs, 
      query, 
      orderBy, 
      serverTimestamp,
      updateDoc,
      doc,
      arrayUnion,
      arrayRemove 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDP01Wi0jp523In30Xk_X83iOigfI6D038",
      authDomain: "ummahconnect-baf90.firebaseapp.com",
      projectId: "ummahconnect-baf90",
      storageBucket: "ummahconnect-baf90.appspot.com",
      messagingSenderId: "700913218056",
      appId: "1:700913218056:web:aacfb20f177993275a17bd",
      measurementId: "G-MHSXKL0V2J"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const postContainer = document.getElementById("postContainer");
    const postInput = document.getElementById("postInput");
    const postBtn = document.getElementById("postBtn");
    const clearPostBtn = document.getElementById("clearPostBtn");
    const postBox = document.getElementById("postBox");
    const logoutBtn = document.getElementById("logoutBtn");

    let currentUser = null;

    // Logout functionality
    logoutBtn.addEventListener("click", async () => {
      try {
        logoutBtn.innerHTML = '<span class="loading-spinner"></span> Logging out...';
        logoutBtn.disabled = true;
        await signOut(auth);
        window.location.href = "index.html";
      } catch (error) {
        alert("Error logging out: " + error.message);
        logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
        logoutBtn.disabled = false;
      }
    });

    // Clear post input
    clearPostBtn.addEventListener("click", () => {
      postInput.value = "";
    });

    async function loadPosts() {
      postContainer.innerHTML = '<div class="flex justify-center py-8"><span class="loading-spinner"></span></div>';
      
      try {
        const postsQuery = query(collection(db, "posts"), orderBy("timestamp", "desc"));
        const snapshot = await getDocs(postsQuery);

        // Clear container
        postContainer.innerHTML = "";

        if (snapshot.empty) {
          postContainer.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-comments"></i>
              <h3 class="text-xl font-medium mb-2">No posts yet</h3>
              <p>Be the first to start a conversation!</p>
            </div>
          `;
          return;
        }

        snapshot.docs.forEach(async (docSnap) => {
          const post = docSnap.data();
          const postId = docSnap.id;

          const card = document.createElement("div");
          card.className = "post-card bg-white rounded-xl shadow-sm border border-gray-100 p-5 animate-fadeIn";

          // Format timestamp
          const postTime = post.timestamp?.seconds 
            ? new Date(post.timestamp.seconds * 1000).toLocaleString()
            : "Just now";

          // Check if current user liked this post
          const userLiked = currentUser && post.likes && post.likes.includes(currentUser.uid);

          card.innerHTML = `
            <div class="flex gap-4">
              <!-- Author Avatar -->
              <div class="flex-shrink-0">
                ${post.authorLogo
                  ? `<img src="${post.authorLogo}" alt="Avatar" class="w-12 h-12 rounded-full object-cover border-2 border-indigo-100">`
                  : `<div class="w-12 h-12 flex items-center justify-center bg-indigo-100 text-indigo-700 font-bold text-lg rounded-full">${post.author?.charAt(0) || 'U'}</div>`
                }
              </div>
              
              <!-- Post Content -->
              <div class="flex-1 min-w-0">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2 mb-3">
                  <div>
                    <h3 class="font-semibold text-gray-800">${post.author || 'Anonymous'}</h3>
                    <p class="text-xs text-gray-500 flex items-center gap-1 mt-1">
                      <i class="fas fa-user-tag"></i> ${post.authorType || "Community Member"}
                    </p>
                  </div>
                  <span class="text-xs text-gray-400 flex items-center gap-1">
                    <i class="far fa-clock"></i> ${postTime}
                  </span>
                </div>
                
                <p class="text-gray-700 mb-4 whitespace-pre-wrap">${post.content}</p>
                
                <!-- Post Actions -->
                <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                  <div class="flex gap-4 text-gray-500 text-sm">
                    <button class="like-btn flex items-center gap-1 ${userLiked ? 'liked' : ''}" onclick="toggleLike('${postId}')">
                      <i class="fas fa-thumbs-up ${userLiked ? 'text-indigo-600' : ''}"></i>
                      <span>${post.likes ? post.likes.length : 0}</span>
                    </button>
                    <button class="text-indigo-600 hover:text-indigo-500 flex items-center gap-1" onclick="toggleReply('${postId}')">
                      <i class="fas fa-reply"></i> Reply
                    </button>
                  </div>
                </div>
                
                <!-- Replies Section -->
                <div id="replies-${postId}" class="mt-4 space-y-3"></div>
                
                <!-- Reply Input (hidden by default) -->
                <div id="replyBox-${postId}" class="hidden mt-4">
                  <div class="flex gap-2">
                    <input type="text" id="replyInput-${postId}" placeholder="Write a reply..." 
                      class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500">
                    <button onclick="submitReply('${postId}')" 
                      class="bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-500 transition flex items-center gap-2">
                      <i class="fas fa-paper-plane"></i> Send
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;

          postContainer.appendChild(card);

          // Load replies for this post
          await loadReplies(postId);
        });
      } catch (error) {
        console.error("Error loading posts:", error);
        postContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3 class="text-xl font-medium mb-2">Error loading posts</h3>
            <p>Please try refreshing the page</p>
          </div>
        `;
      }
    }

    async function loadReplies(postId) {
      const repliesDiv = document.getElementById(`replies-${postId}`);
      if (!repliesDiv) return;
      
      repliesDiv.innerHTML = '<div class="flex justify-center py-2"><span class="loading-spinner small"></span></div>';
      
      try {
        const repliesSnapshot = await getDocs(collection(db, "posts", postId, "replies"));
        
        // Clear loading indicator
        repliesDiv.innerHTML = "";
        
        if (repliesSnapshot.empty) {
          return;
        }
        
        // Sort replies by timestamp
        const replies = [];
        repliesSnapshot.docs.forEach(replySnap => {
          replies.push({ id: replySnap.id, ...replySnap.data() });
        });
        
        replies.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
        
        replies.forEach(reply => {
          const replyTime = reply.timestamp?.seconds 
            ? new Date(reply.timestamp.seconds * 1000).toLocaleString()
            : "Just now";
            
          const replyEl = document.createElement("div");
          replyEl.className = "reply-section animate-fadeIn";
          replyEl.innerHTML = `
            <div class="flex gap-3">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 flex items-center justify-center bg-gray-200 text-gray-700 font-bold text-sm rounded-full">
                  ${reply.author?.charAt(0) || 'U'}
                </div>
              </div>
              <div class="flex-1">
                <div class="flex justify-between items-start mb-1">
                  <strong class="text-sm text-gray-800">${reply.author || 'Anonymous'}</strong>
                  <span class="text-xs text-gray-400">${replyTime}</span>
                </div>
                <p class="text-sm text-gray-700">${reply.content}</p>
              </div>
            </div>
          `;
          repliesDiv.appendChild(replyEl);
        });
      } catch (error) {
        console.error("Error loading replies:", error);
        repliesDiv.innerHTML = '<p class="text-sm text-gray-500">Error loading replies</p>';
      }
    }

    window.toggleReply = function(postId) {
      if (!currentUser) {
        alert("You must be logged in to reply!");
        return;
      }
      
      const box = document.getElementById(`replyBox-${postId}`);
      box.classList.toggle("hidden");
      
      // Focus on the input when showing
      if (!box.classList.contains("hidden")) {
        setTimeout(() => {
          const input = document.getElementById(`replyInput-${postId}`);
          if (input) input.focus();
        }, 100);
      }
    };

    window.submitReply = async function(postId) {
      if (!currentUser) return alert("You must be logged in to reply!");
      
      const input = document.getElementById(`replyInput-${postId}`);
      const content = input.value.trim();
      
      if (!content) return alert("Reply cannot be empty!");

      try {
        // Show loading state
        const originalText = input.nextElementSibling.innerHTML;
        input.nextElementSibling.innerHTML = '<span class="loading-spinner"></span>';
        input.nextElementSibling.disabled = true;
        
        await addDoc(collection(db, "posts", postId, "replies"), {
          author: currentUser.displayName || currentUser.email.split("@")[0],
          content,
          timestamp: serverTimestamp()
        });

        input.value = "";
        input.nextElementSibling.innerHTML = originalText;
        input.nextElementSibling.disabled = false;
        
        // Hide reply box after successful submission
        document.getElementById(`replyBox-${postId}`).classList.add("hidden");
        
        // Reload replies for this post
        await loadReplies(postId);
      } catch (error) {
        console.error("Error submitting reply:", error);
        alert("Error posting reply: " + error.message);
      }
    };

    window.toggleLike = async function(postId) {
      if (!currentUser) {
        alert("You must be logged in to like posts!");
        return;
      }
      
      try {
        const postRef = doc(db, "posts", postId);
        const likeBtn = document.querySelector(`button[onclick="toggleLike('${postId}')"]`);
        const icon = likeBtn.querySelector('i');
        const countSpan = likeBtn.querySelector('span');
        
        // Get current post data to check if user already liked it
        const postsQuery = query(collection(db, "posts"));
        const snapshot = await getDocs(postsQuery);
        let postData = null;
        
        snapshot.docs.forEach(docSnap => {
          if (docSnap.id === postId) {
            postData = docSnap.data();
          }
        });
        
        if (!postData) return;
        
        const currentLikes = postData.likes || [];
        const userLiked = currentLikes.includes(currentUser.uid);
        
        if (userLiked) {
          // Unlike the post
          await updateDoc(postRef, {
            likes: arrayRemove(currentUser.uid)
          });
          likeBtn.classList.remove('liked');
          icon.classList.remove('text-indigo-600');
          countSpan.textContent = parseInt(countSpan.textContent) - 1;
        } else {
          // Like the post
          await updateDoc(postRef, {
            likes: arrayUnion(currentUser.uid)
          });
          likeBtn.classList.add('liked');
          icon.classList.add('text-indigo-600');
          countSpan.textContent = parseInt(countSpan.textContent) + 1;
        }
      } catch (error) {
        console.error("Error toggling like:", error);
        alert("Error updating like: " + error.message);
      }
    };

    postBtn.addEventListener("click", async () => {
      if (!currentUser) return alert("You must be logged in to post!");
      
      const content = postInput.value.trim();
      if (!content) return alert("Post cannot be empty!");

      try {
        // Show loading state
        const originalText = postBtn.innerHTML;
        postBtn.innerHTML = '<span class="loading-spinner"></span> Posting...';
        postBtn.disabled = true;
        
        await addDoc(collection(db, "posts"), {
          author: currentUser.displayName || currentUser.email.split("@")[0],
          authorType: "Community Member",
          content,
          timestamp: serverTimestamp(),
          likes: []
        });

        postInput.value = "";
        postBtn.innerHTML = originalText;
        postBtn.disabled = false;
        
        loadPosts();
      } catch (error) {
        console.error("Error creating post:", error);
        alert("Error creating post: " + error.message);
        postBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Post';
        postBtn.disabled = false;
      }
    });

    // Allow submitting post with Ctrl+Enter
    postInput.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.key === "Enter") {
        postBtn.click();
      }
    });

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        postBox.classList.remove("hidden");
      } else {
        currentUser = null;
        postBox.classList.add("hidden");
      }
      loadPosts();
    });

    window.addEventListener("DOMContentLoaded", () => {
      // Initial load
      loadPosts();
    });
  </script>
</body>
</html>
