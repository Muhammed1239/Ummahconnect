<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feed - UmmahConnect</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* Custom styles for enhanced UI */
    .org-card {
      transition: all 0.3s ease;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .org-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .filter-section {
      background: linear-gradient(to right, #f8fafc, #f1f5f9);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .popup-content {
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6b7280;
    }
    
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      color: #d1d5db;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(79, 70, 229, 0.3);
      border-radius: 50%;
      border-top-color: #4f46e5;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .section-title {
      position: relative;
      padding-bottom: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
    .section-title:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50px;
      height: 3px;
      background-color: #4f46e5;
      border-radius: 3px;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDP01Wi0jp523In30Xk_X83iOigfI6D038",
      authDomain: "ummahconnect-baf90.firebaseapp.com",
      projectId: "ummahconnect-baf90",
      storageBucket: "ummahconnect-baf90.appspot.com",
      messagingSenderId: "700913218056",
      appId: "1:700913218056:web:aacfb20f177993275a17bd",
      measurementId: "G-MHSXKL0V2J"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const orgContainer = document.getElementById("orgContainer");
    const countryFilter = document.getElementById("countryFilter");
    const sectorFilter = document.getElementById("sectorFilter");
    const searchInput = document.getElementById("searchInput");
    const logoutBtn = document.getElementById("logoutBtn");
    const clearFiltersBtn = document.getElementById("clearFiltersBtn");
    const resultsCount = document.getElementById("resultsCount");

    // Logout functionality
    logoutBtn.addEventListener("click", async () => {
      try {
        logoutBtn.innerHTML = '<span class="loading-spinner"></span> Logging out...';
        logoutBtn.disabled = true;
        await signOut(auth);
        window.location.href = "index.html"; // redirect after logout
      } catch (error) {
        alert("Error logging out: " + error.message);
        logoutBtn.innerHTML = 'Logout';
        logoutBtn.disabled = false;
      }
    });

    // Clear filters functionality
    clearFiltersBtn.addEventListener("click", () => {
      countryFilter.value = "";
      sectorFilter.value = "";
      searchInput.value = "";
      loadOrgs();
    });

    async function loadOrgs() {
      orgContainer.innerHTML = '<div class="col-span-full flex justify-center py-8"><span class="loading-spinner"></span></div>';
      
      try {
        const snapshot = await getDocs(collection(db, "users"));
        let orgs = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));

        // Filter only approved organizations
        orgs = orgs.filter(org => org.accountType === "organization" && org.approved);

        const country = countryFilter.value.toLowerCase();
        const sector = sectorFilter.value.toLowerCase();
        const search = searchInput.value.toLowerCase();

        orgs = orgs.filter(org =>
          (country === "" || org.country?.toLowerCase() === country) &&
          (sector === "" || org.sector?.toLowerCase() === sector) &&
          (search === "" || org.orgName?.toLowerCase().includes(search))
        );

        // Update results count
        resultsCount.textContent = `${orgs.length} organization${orgs.length !== 1 ? 's' : ''} found`;

        // Clear container
        orgContainer.innerHTML = "";

        if (orgs.length === 0) {
          orgContainer.innerHTML = `
            <div class="col-span-full empty-state">
              <i class="fas fa-search"></i>
              <h3 class="text-xl font-medium mb-2">No organizations found</h3>
              <p>Try adjusting your filters or search terms</p>
            </div>
          `;
          return;
        }

        orgs.forEach(org => {
          const card = document.createElement("div");
          card.className = "org-card bg-white rounded-xl shadow-md border border-gray-100 p-5";

          // Avatar
          const avatar = org.logo
            ? `<img src="${org.logo}" alt="Logo" class="w-16 h-16 rounded-lg object-cover border-2 border-indigo-100 shadow-sm">`
            : `<div class="w-16 h-16 flex items-center justify-center bg-indigo-100 text-indigo-700 font-bold text-xl rounded-lg">${org.orgName?.charAt(0) || 'O'}</div>`;

          // Card content
          card.innerHTML = `
            <div class="flex flex-col items-center gap-4">
              ${avatar}
              <div class="text-center">
                <h3 class="text-lg font-semibold text-gray-800 mb-1">${org.orgName || 'Unnamed Organization'}</h3>
                <div class="flex flex-col gap-1 mt-2 text-sm text-gray-600">
                  <span class="inline-flex items-center gap-1"><i class="fa fa-briefcase text-indigo-500"></i> ${org.sector || 'Not specified'}</span>
                  <span class="inline-flex items-center gap-1"><i class="fa fa-globe text-indigo-500"></i> ${org.country || 'Not specified'}</span>
                </div>
              </div>
              <button class="view-details-btn mt-2 px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-colors text-sm font-medium">
                View Details
              </button>
            </div>
          `;

          // Click event for the view details button
          const viewDetailsBtn = card.querySelector('.view-details-btn');
          viewDetailsBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent card click event
            openPopup(org);
          });

          // Click anywhere on card -> open popup
          card.addEventListener("click", () => openPopup(org));

          orgContainer.appendChild(card);
        });
      } catch (error) {
        console.error("Error loading organizations:", error);
        orgContainer.innerHTML = `
          <div class="col-span-full empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3 class="text-xl font-medium mb-2">Error loading organizations</h3>
            <p>Please try refreshing the page</p>
          </div>
        `;
      }
    }

    function openPopup(org) {
      const popup = document.getElementById("orgPopup");
      const popupContent = document.getElementById("popupContent");

      popupContent.innerHTML = `
        <div class="flex flex-col items-center mb-4">
          ${org.logo 
            ? `<img src="${org.logo}" alt="Logo" class="w-20 h-20 rounded-lg object-cover border-2 border-indigo-100 mb-3">` 
            : `<div class="w-20 h-20 flex items-center justify-center bg-indigo-100 text-indigo-700 font-bold text-2xl rounded-lg mb-3">${org.orgName?.charAt(0) || 'O'}</div>`
          }
          <h2 class="text-xl font-bold text-center">${org.orgName || 'Unnamed Organization'}</h2>
        </div>
        
        <div class="space-y-3">
          <div>
            <h3 class="font-medium text-gray-700 mb-1">About</h3>
            <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">${org.briefing || "No description available."}</p>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-indigo-50 p-3 rounded-lg">
              <p class="text-xs text-indigo-600 font-medium">Sector</p>
              <p class="text-sm font-medium">${org.sector || 'Not specified'}</p>
            </div>
            <div class="bg-indigo-50 p-3 rounded-lg">
              <p class="text-xs text-indigo-600 font-medium">Country</p>
              <p class="text-sm font-medium">${org.country || 'Not specified'}</p>
            </div>
          </div>
          
          <div>
            <h3 class="font-medium text-gray-700 mb-1">Contact Information</h3>
            <div class="space-y-2 text-sm">
              <p class="flex items-center gap-2"><i class="fas fa-envelope text-gray-500"></i> ${org.email || "Not provided"}</p>
              <p class="flex items-center gap-2"><i class="fas fa-phone text-gray-500"></i> ${org.contact || "Not provided"}</p>
              ${org.website ? `<a href="${org.website}" target="_blank" class="flex items-center gap-2 text-indigo-600 hover:text-indigo-500"><i class="fas fa-globe"></i> Visit Website</a>` : ""}
            </div>
          </div>
        </div>
        
        ${org.website ? `
          <div class="mt-5 text-center">
            <a href="${org.website}" target="_blank" class="inline-block px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-500 transition-colors font-medium">
              Visit Website
            </a>
          </div>
        ` : ""}
      `;
      
      popup.classList.remove("hidden");
      document.body.style.overflow = 'hidden'; // Prevent scrolling when popup is open
    }

    function closePopup() {
      document.getElementById("orgPopup").classList.add("hidden");
      document.body.style.overflow = 'auto'; // Restore scrolling
    }

    // Close when clicking outside or pressing Escape
    window.addEventListener("click", (e) => {
      const popup = document.getElementById("orgPopup");
      if (e.target === popup) closePopup();
    });
    
    window.addEventListener("keydown", (e) => {
      if (e.key === 'Escape') closePopup();
    });

    // Event listeners for filters
    countryFilter.addEventListener("change", loadOrgs);
    sectorFilter.addEventListener("change", loadOrgs);
    searchInput.addEventListener("input", loadOrgs);
    
    // Initialize on page load
    window.addEventListener("DOMContentLoaded", loadOrgs);

    window.closePopup = closePopup; // expose for button
  </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

  <!-- Navbar -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto flex flex-col md:flex-row justify-between items-center py-4 px-6 gap-3 md:gap-0">
      <div class="flex items-center gap-2">
        <h1 class="text-2xl font-bold text-indigo-600">UmmahConnect</h1>
        <span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full font-medium">Feed</span>
      </div>
      <nav class="flex gap-5 items-center flex-wrap justify-center">
        <a href="feed.html" class="text-indigo-600 font-medium border-b-2 border-indigo-600 pb-1 transition">Feed</a>
        <a href="discussion.html" class="text-gray-600 hover:text-indigo-600 transition">Discussion</a>
        <a href="profile.html" class="text-gray-600 hover:text-indigo-600 transition">Profile</a>
        <button id="logoutBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-500 transition flex items-center gap-2">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto my-8 px-4 md:px-6">

    <!-- Filters Section -->
    <div class="filter-section shadow-sm mb-8">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
        <div class="flex gap-3">
          <span id="resultsCount" class="bg-indigo-100 text-indigo-800 text-sm px-3 py-1 rounded-full">Loading...</span>
          <button id="clearFiltersBtn" class="text-sm text-gray-600 hover:text-indigo-600 flex items-center gap-1">
            <i class="fas fa-times"></i> Clear filters
          </button>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="md:col-span-2">
          <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Search by name</label>
          <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="searchInput" placeholder="Search organizations..." class="pl-10 p-3 rounded-lg border border-gray-300 w-full focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500">
          </div>
        </div>
        
        <div>
          <label for="countryFilter" class="block text-sm font-medium text-gray-700 mb-1">Country</label>
          <div class="relative">
            <i class="fas fa-globe absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <select id="countryFilter" class="pl-10 p-3 rounded-lg border border-gray-300 w-full focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 appearance-none">
              <option value="">All Countries</option>
              <option value="India">India</option>
              <option value="USA">USA</option>
              <option value="UK">UK</option>
              <option value="Other">Other</option>
            </select>
            <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
          </div>
        </div>
        
        <div>
          <label for="sectorFilter" class="block text-sm font-medium text-gray-700 mb-1">Sector</label>
          <div class="relative">
            <i class="fas fa-briefcase absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <select id="sectorFilter" class="pl-10 p-3 rounded-lg border border-gray-300 w-full focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 appearance-none">
              <option value="">All Sectors</option>
              <option value="Medical">Medical</option>
              <option value="Education">Education</option>
              <option value="Social Service">Social Service</option>
              <option value="Others">Others</option>
            </select>
            <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Organization Cards Grid -->
    <div class="grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3" id="orgContainer">
      <!-- Cards inserted dynamically from Firebase -->
    </div>
  </main>

  <!-- Popup -->
  <div id="orgPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50 p-4">
    <div class="bg-white p-6 rounded-xl w-full max-w-md popup-content relative shadow-xl">
      <button onclick="closePopup()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 bg-gray-100 w-8 h-8 rounded-full flex items-center justify-center">
        <i class="fas fa-times"></i>
      </button>
      <div id="popupContent"></div>
    </div>
  </div>

</body>
</html>
